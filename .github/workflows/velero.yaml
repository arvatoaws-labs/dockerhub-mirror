name: velero

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  schedule:
  # * is a special character in YAML so you have to quote this string
  - cron: '40 9 * * *'

jobs:
  mirror:
    runs-on: ubuntu-latest
    #permissions: write-all
    #permissions:
      #packages: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Generate token
      id: generate-token
      uses: tibdex/github-app-token@v2
      with:
        app_id: ${{ secrets.DOCKER_PULL_PUSH_APP_ID }}
        private_key: ${{ secrets.DOCKER_PULL_PUSH_APP_PRIVATE_KEY }}

    - name: Get Current Branch Name
      id: get_branch
      run: git rev-parse --abbrev-ref HEAD

    - name: Mirror
      uses: arvatoaws-labs/dockerhub-mirror@cr/jenkins_removal
      with:
        src-username: ${{ secrets.DOCKERHUB_USERNAME }}
        src-password: ${{ secrets.DOCKERHUB_TOKEN }}
        dst-username: $ #${{ secrets.DOCKER_PULL_PUSH_APP_ID }} #${{ secrets.CR_USERNAME }}
        dst-password: ${{ secrets.GITHUB_TOKEN }} #${{ steps.generate-token.outputs.token }} #${{ secrets.CR_PAT }}
        config: config/generic.yaml
        loglevel: debug

        src-repo: velero/velero
        dst-repo: arvatoaws-labs/velero
