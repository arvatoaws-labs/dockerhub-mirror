# https://help.github.com/en/articles/metadata-syntax-for-github-actions
name: 'DockerHub mirror'
description: 'GitHub Action to mirror a DockerHub repo to another registry'
author: 'arvatoaws-labs'
branding:
  color: 'green'
  icon: 'copy'

inputs:

  src-username:
    description: 'Source username'
    required: true
  src-password:
    description: 'Source password'
    required: true
  src-registry:
    description: 'Source registry (eg. docker.io)'
    required: true
    default: docker.io
  src-repo:
    description: 'Source repo (eg. library/busybox)'
    required: true

  dst-username:
    description: 'Destination username'
    required: true
  dst-password:
    description: 'Destination password'
    required: true
  dst-registry:
    description: 'Destination registry (eg. ghcr.io)'
    required: true
    default: ghcr.io
  dst-repo:
    description: 'Destination repo (eg. myrepo/busybox)'
    required: true

  config:
    description: 'configfile to use'
    required: true
    default: config/generic.yaml

runs:
  using: 'composite'
  steps:
    -
      run: |
        set -e
        SRC_USER=${{ inputs.src-username }}
        SRC_PASS=${{ inputs.src-password }}
        SRC_REGISTRY=${{ inputs.src-registry }}
        SRC_REPO=${{ inputs.src-repo }}
        DST_USER=${{ inputs.dst-username }}
        DST_PASS=${{ inputs.dst-password }}
        DST_REPO=${{ inputs.dst-repo }}
        DST_REGISTRY=${{ inputs.dst-registry }}
        CONFIG=${{ inputs.config }}

        DRYRUN_FLAG="--dry-run"
        if [ "${{ inputs.dry-run }}" = "false" ]; then
          DRYRUN_FLAG=""
        fi

        wget https://github.com/regclient/regclient/releases/download/v0.5.1/regsync-linux-amd64
        chmod 755 regsync-linux-amd64

        ./regsync-linux-amd64 -c $CONFIG once
      shell: bash
